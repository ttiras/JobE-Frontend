# Data Model: Nhost Integration

**Date**: 2025-10-22  
**Feature**: 002-nhost-integration

## Overview

Data model for Nhost-powered authentication, storage, and business entities in PostgreSQL with GraphQL API. This model defines the schema managed by Hasura on Nhost.

## Core Principles

- **Row-Level Security (RLS)**: Every table has permission rules based on user roles
- **Referential Integrity**: Foreign keys enforce relationships
- **Audit Trail**: Created/updated timestamps on all mutable entities
- **Soft Deletes**: Critical data (Applications) use soft deletes; user accounts use hard deletes (FR-012)
- **UUID Primary Keys**: All entities use UUIDs for globally unique identifiers

---

## Entity Definitions

### 1. User (Managed by Nhost Auth)

**Description**: Platform users authenticated via Nhost authentication system

**Table**: `auth.users` (Nhost managed)

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK, NOT NULL | User identifier (auto-generated by Nhost) |
| email | VARCHAR(255) | UNIQUE, NOT NULL | User email address |
| email_verified | BOOLEAN | DEFAULT false | Email verification status |
| display_name | VARCHAR(255) | NULL | User's full name |
| avatar_url | TEXT | NULL | URL to profile picture in Nhost Storage |
| locale | VARCHAR(10) | DEFAULT 'en' | Preferred language (en/tr) |
| default_role | VARCHAR(50) | NOT NULL | Default user role (user, admin) |
| disabled | BOOLEAN | DEFAULT false | Account disabled status |
| created_at | TIMESTAMPTZ | NOT NULL | Account creation timestamp |
| updated_at | TIMESTAMPTZ | NOT NULL | Last update timestamp |

**Validation Rules**:
- Email must be valid format (enforced by Nhost)
- Password minimum 8 characters, 1 uppercase, 1 lowercase, 1 number (FR-003)
- Display name max 255 characters

**Relationships**:
- One-to-many with `user_roles`
- One-to-many with `files`
- One-to-many with `applications`
- One-to-many with `organizations` (as creator/owner)

**Notes**:
- Nhost manages this table directly
- Hard delete on account deletion (FR-012) - cascades to related data
- Email verification required for account activation (FR-009)

---

### 2. Role

**Description**: User roles for role-based access control (RBAC)

**Table**: `public.roles`

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK, NOT NULL | Role identifier |
| name | VARCHAR(50) | UNIQUE, NOT NULL | Role name (admin, employer, candidate) |
| description | TEXT | NULL | Role description |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | Creation timestamp |

**Validation Rules**:
- Name must be unique
- Name must be one of: admin, employer, candidate

**Relationships**:
- One-to-many with `user_roles`

**Initial Data** (Seed):
```sql
INSERT INTO roles (name, description) VALUES
  ('admin', 'System administrator with full access'),
  ('employer', 'Organization representative managing positions'),
  ('candidate', 'Job applicant submitting applications');
```

---

### 3. UserRole

**Description**: Junction table linking users to roles (many-to-many)

**Table**: `public.user_roles`

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK, NOT NULL | UserRole identifier |
| user_id | UUID | FK(auth.users.id), NOT NULL | Reference to user |
| role_id | UUID | FK(roles.id), NOT NULL | Reference to role |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | Assignment timestamp |

**Validation Rules**:
- Unique constraint on (user_id, role_id) - no duplicate assignments

**Relationships**:
- Many-to-one with `auth.users`
- Many-to-one with `roles`

**RLS Policy**:
- Users can read their own roles
- Only admins can assign/revoke roles

---

### 4. Organization

**Description**: Companies/employers using the platform

**Table**: `public.organizations`

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK, NOT NULL | Organization identifier |
| name | VARCHAR(255) | NOT NULL | Organization name |
| description | TEXT | NULL | Organization description |
| industry | VARCHAR(100) | NULL | Industry sector |
| website | VARCHAR(255) | NULL | Company website URL |
| logo_file_id | UUID | FK(files.id), NULL | Reference to logo file |
| created_by | UUID | FK(auth.users.id), NOT NULL | User who created organization |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | Last update timestamp |

**Validation Rules**:
- Name required, max 255 characters
- Website must be valid URL format if provided
- Name must be unique per creator (users can't create duplicate org names)

**Relationships**:
- Many-to-one with `auth.users` (created_by)
- One-to-many with `positions`
- Many-to-one with `files` (logo)

**RLS Policy**:
- Employers can create organizations
- Users can read organizations
- Only creator or admin can update/delete organization

**Indexes**:
- created_by (for user's organizations queries)
- name (for search/autocomplete)

---

### 5. Position

**Description**: Job openings posted by organizations

**Table**: `public.positions`

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK, NOT NULL | Position identifier |
| organization_id | UUID | FK(organizations.id), NOT NULL | Reference to organization |
| title | VARCHAR(255) | NOT NULL | Position title |
| description | TEXT | NOT NULL | Job description |
| requirements | TEXT | NULL | Job requirements |
| location | VARCHAR(255) | NULL | Job location |
| employment_type | VARCHAR(50) | NULL | Full-time, part-time, contract, etc. |
| salary_min | INTEGER | NULL | Minimum salary (optional) |
| salary_max | INTEGER | NULL | Maximum salary (optional) |
| currency | VARCHAR(3) | DEFAULT 'USD' | Salary currency code |
| status | VARCHAR(50) | DEFAULT 'draft' | draft, published, closed |
| questionnaire_id | UUID | FK(questionnaires.id), NULL | Associated questionnaire |
| created_by | UUID | FK(auth.users.id), NOT NULL | User who created position |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | Last update timestamp |
| published_at | TIMESTAMPTZ | NULL | Publication timestamp |
| closed_at | TIMESTAMPTZ | NULL | Closure timestamp |

**Validation Rules**:
- Title required, max 255 characters
- Description required
- Status must be one of: draft, published, closed
- If salary_min and salary_max both set, salary_max >= salary_min
- Employment type one of: full-time, part-time, contract, internship, temporary

**State Transitions**:
- draft → published (sets published_at)
- published → closed (sets closed_at)
- Cannot reopen closed positions

**Relationships**:
- Many-to-one with `organizations`
- Many-to-one with `auth.users` (created_by)
- Many-to-one with `questionnaires` (optional)
- One-to-many with `applications`

**RLS Policy**:
- Employers can create positions for their organizations
- Published positions readable by all users
- Draft positions readable only by creator and admins
- Only creator or admin can update/delete position

**Indexes**:
- organization_id (for organization's positions)
- status (for filtering by status)
- created_at (for sorting)
- (title, description) full-text search index

---

### 6. Questionnaire

**Description**: Assessment forms for evaluating candidates

**Table**: `public.questionnaires`

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK, NOT NULL | Questionnaire identifier |
| title | VARCHAR(255) | NOT NULL | Questionnaire title |
| description | TEXT | NULL | Questionnaire description |
| questions | JSONB | NOT NULL | Array of question objects |
| scoring_rules | JSONB | NULL | Scoring configuration |
| created_by | UUID | FK(auth.users.id), NOT NULL | User who created questionnaire |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | Last update timestamp |

**Questions JSONB Structure**:
```json
[
  {
    "id": "q1",
    "type": "multiple_choice",
    "text": "What is your experience level?",
    "options": ["Entry", "Mid", "Senior", "Expert"],
    "required": true,
    "weight": 1.0
  },
  {
    "id": "q2",
    "type": "text",
    "text": "Describe your relevant experience",
    "required": true,
    "max_length": 500
  }
]
```

**Scoring Rules JSONB Structure**:
```json
{
  "type": "weighted_average",
  "pass_threshold": 70,
  "question_weights": {
    "q1": 2.0,
    "q2": 1.0
  }
}
```

**Validation Rules**:
- Title required, max 255 characters
- Questions must be valid JSONB array
- Each question must have id, type, text, required fields

**Relationships**:
- Many-to-one with `auth.users` (created_by)
- One-to-many with `positions`

**RLS Policy**:
- Employers can create questionnaires
- Users can read questionnaires associated with published positions
- Only creator or admin can update/delete questionnaire

---

### 7. Application

**Description**: Candidate submissions for job positions

**Table**: `public.applications`

**Fields**:
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK, NOT NULL | Application identifier |
| position_id | UUID | FK(positions.id), NOT NULL | Reference to position |
| user_id | UUID | FK(auth.users.id), NOT NULL | Reference to applicant |
| status | VARCHAR(50) | DEFAULT 'submitted' | Application status |
| answers | JSONB | NULL | Questionnaire answers |
| score | DECIMAL(5,2) | NULL | Calculated score |
| resume_file_id | UUID | FK(files.id), NULL | Reference to resume file |
| cover_letter | TEXT | NULL | Cover letter text |
| notes | TEXT | NULL | Internal notes (employer only) |
| submitted_at | TIMESTAMPTZ | DEFAULT NOW() | Submission timestamp |
| reviewed_at | TIMESTAMPTZ | NULL | Review timestamp |
| reviewed_by | UUID | FK(auth.users.id), NULL | Reviewer user |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | Last update timestamp |

**Validation Rules**:
- One application per user per position (unique constraint)
- Status must be one of: submitted, under_review, interview, rejected, accepted
- Score between 0 and 100 if set

**Status Workflow**:
- submitted → under_review → interview → accepted/rejected
- Can skip interview: under_review → accepted/rejected

**Answers JSONB Structure**:
```json
{
  "q1": "Senior",
  "q2": "5 years of experience in..."
}
```

**Relationships**:
- Many-to-one with `positions`
- Many-to-one with `auth.users` (applicant)
- Many-to-one with `auth.users` (reviewer)
- Many-to-one with `files` (resume)

**RLS Policy**:
- Candidates can create applications for published positions
- Candidates can read/update only their own applications
- Employers can read applications for their organization's positions
- Only employer or admin can update status, notes, review fields

**Indexes**:
- position_id (for position's applications)
- user_id (for user's applications)
- status (for filtering)
- submitted_at (for sorting)

---

### 8. File

**Description**: Uploaded files stored in Nhost Storage

**Table**: `storage.files` (Nhost managed) + `public.file_metadata`

**Nhost Storage Fields** (storage.files):
| Field | Type | Description |
|-------|------|-------------|
| id | UUID | File identifier (Nhost managed) |
| bucket_id | VARCHAR(255) | Storage bucket name |
| name | VARCHAR(255) | Original filename |
| size | INTEGER | File size in bytes |
| mime_type | VARCHAR(255) | MIME type |
| uploaded_by_user_id | UUID | Reference to uploader |
| created_at | TIMESTAMPTZ | Upload timestamp |
| updated_at | TIMESTAMPTZ | Last update timestamp |

**Extended Metadata** (public.file_metadata):
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK, FK(storage.files.id) | Reference to file |
| category | VARCHAR(50) | NOT NULL | resume, logo, document, photo |
| description | TEXT | NULL | File description |
| malware_scan_status | VARCHAR(50) | DEFAULT 'pending' | pending, clean, infected |
| malware_scan_at | TIMESTAMPTZ | NULL | Scan timestamp |

**Validation Rules**:
- File size max 10MB (FR-018, enforced at upload)
- Supported MIME types: 
  - Documents: application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document
  - Images: image/jpeg, image/png
- Category must be one of: resume, logo, document, photo

**Relationships**:
- Many-to-one with `auth.users` (uploaded_by_user_id)
- One-to-many with `applications` (resume)
- One-to-many with `organizations` (logo)

**RLS Policy**:
- Users can upload files to their own account
- Users can read/delete only their own files
- Employers can read files attached to applications for their positions
- Files deleted when user account is deleted (cascade)

**Storage Buckets**:
- `resumes`: For candidate resumes
- `logos`: For organization logos
- `documents`: For general documents
- `photos`: For profile pictures

**Indexes**:
- uploaded_by_user_id (for user's files)
- category (for filtering by type)
- created_at (for sorting)

---

## Database Schema Diagram

```
┌──────────────┐
│  auth.users  │
│ (Nhost Auth) │
└──────┬───────┘
       │
       ├──────────────────────┐
       │                      │
       ▼                      ▼
┌──────────────┐      ┌─────────────┐
│  user_roles  │◄─────┤    roles    │
└──────────────┘      └─────────────┘

       │
       ├──────────────────────────────────┐
       │                                  │
       ▼                                  ▼
┌─────────────────┐              ┌──────────────────┐
│ organizations   │              │ questionnaires   │
└────────┬────────┘              └──────────────────┘
         │                                  │
         │                                  │
         ▼                                  │
┌─────────────────┐◄──────────────────────┘
│   positions     │
└────────┬────────┘
         │
         │
         ▼
┌─────────────────┐      ┌──────────────────┐
│  applications   │─────►│ storage.files +  │
└─────────────────┘      │ file_metadata    │
                         └──────────────────┘
```

---

## Permissions Model (Hasura RLS)

### Admin Role
- Full access to all tables (CRUD)
- Can assign roles to users
- Can view all applications and organizations

### Employer Role
- Can create organizations
- Can create positions for their organizations
- Can create questionnaires
- Can view applications for their positions
- Can update application status and notes
- Can view files attached to applications

### Candidate Role
- Can view published positions
- Can create applications
- Can upload files (resumes)
- Can view/update only their own applications
- Can view organizations

### Anonymous (Not Logged In)
- Can view published positions (read-only)
- Can view organizations (read-only)
- No write access

---

## Migrations Strategy

### Initial Migration
1. Create custom tables (roles, user_roles, organizations, positions, questionnaires, applications, file_metadata)
2. Set up foreign keys and indexes
3. Configure RLS policies in Hasura
4. Seed initial roles

### Schema Updates
- Use Hasura migrations (stored in version control)
- Test in local Nhost instance first
- Apply to staging, verify, then production
- Never modify Nhost-managed tables directly

### Migration Files Location
```
/Users/tacettintiras/Documents/JobE-Frontend/specs/002-nhost-integration/contracts/migrations/
├── 001_create_roles.sql
├── 002_create_user_roles.sql
├── 003_create_organizations.sql
├── 004_create_positions.sql
├── 005_create_questionnaires.sql
├── 006_create_applications.sql
├── 007_create_file_metadata.sql
├── 008_create_indexes.sql
└── 009_seed_roles.sql
```

---

## GraphQL Type Generation

TypeScript types will be auto-generated from this schema using `graphql-codegen`. See `contracts/schema.graphql` for the complete GraphQL schema definition.

---

## Next Steps

With data model defined, proceed to generate GraphQL schema and API contracts in Phase 1.
